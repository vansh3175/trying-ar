<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: monospace;
      z-index: 10000;
    }
    #cursor {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <a-scene 
    embedded 
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: true"
    renderer="logarithmicDepthBuffer: true;"
  >
    <!-- Enhanced cursor with visual feedback -->
    <a-entity id="cursor"
      cursor="rayOrigin: mouse"
      raycaster="objects: [data-ar-surface]; far: 100;"
      geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
      material="color: #00FF00; shader: flat"
      position="0 0 -1"
      data-ar-surface
    ></a-entity>

    <!-- Plant with physics for realistic placement -->
    <a-entity id="plant"
      gltf-model="url(./plant.glb)"
      scale="0.5 0.5 0.5"
      visible="false"
      shadow
      data-ar-surface
    ></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="debug">Initializing AR...</div>

  <script>
    const scene = document.querySelector('a-scene');
    const cursor = document.getElementById('cursor');
    const plant = document.getElementById('plant');
    const debugEl = document.getElementById('debug');
    
    // Debug states
    let trackingStarted = false;
    let lastIntersection = null;
    
    // Configure raycaster properly
    cursor.components.raycaster.far = 10;
    cursor.components.raycaster.near = 0.05;
    cursor.components.raycaster.showLine = true;
    
    // Scene loaded handler
    scene.addEventListener('loaded', () => {
      debugEl.textContent = "AR ready - scan surfaces slowly";
      
      // Visual feedback when surfaces are detected
      scene.addEventListener('markerFound', () => {
        trackingStarted = true;
        cursor.setAttribute('material', 'color', '#00FF00');
      });
      
      scene.addEventListener('markerLost', () => {
        cursor.setAttribute('material', 'color', '#FF0000');
      });
    });
    
    // Click handler with enhanced debugging
    cursor.addEventListener('click', (e) => {
      if (!e.detail.intersection) {
        debugEl.textContent = "‚ö†Ô∏è No surface detected!\nMove phone slowly over textured surface";
        cursor.setAttribute('material', 'color', '#FF0000');
        return;
      }
      
      lastIntersection = e.detail.intersection;
      plant.setAttribute('position', lastIntersection.point);
      
      // Align plant with surface normal
      plant.setAttribute('rotation', {
        x: -Math.atan2(lastIntersection.face.normal.z, lastIntersection.face.normal.y) * (180/Math.PI),
        y: 0,
        z: 0
      });
      
      plant.setAttribute('visible', 'true');
      debugEl.innerHTML = `‚úÖ Plant placed!<br>
                          Position: ${lastIntersection.point.x.toFixed(2)}, 
                          ${lastIntersection.point.y.toFixed(2)}, 
                          ${lastIntersection.point.z.toFixed(2)}`;
      
      // Visual confirmation
      cursor.setAttribute('material', 'color', '#00FF00');
      setTimeout(() => cursor.setAttribute('material', 'color', '#FFFF00'), 200);
    });
    
    // Continuous debug output
    setInterval(() => {
      if (!trackingStarted) {
        debugEl.textContent = "üîÑ Searching for surfaces...\nMove phone slowly side-to-side";
      }
    }, 2000);
  </script>
</body>
</html>